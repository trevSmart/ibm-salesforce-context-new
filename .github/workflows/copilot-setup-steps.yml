name: "Copilot Setup Steps"

on:
    workflow_dispatch:
    push:
        paths: [.github/workflows/copilot-setup-steps.yml]
    pull_request:
        paths: [.github/workflows/copilot-setup-steps.yml]

jobs:
    copilot-setup-steps:
        runs-on: ubuntu-latest
        environment: copilot
        permissions:
            contents: read

        steps:
            - name: Setup Salesforce Authentication
              uses: ./.github/workflows/salesforce-auth-setup.yml
              with:
                  log_level: "debug"
              secrets:
                  SF_ORG_CLIENT_ID: ${{ secrets.SF_ORG_CLIENT_ID }}
                  SF_ORG_CLIENT_SECRET: ${{ secrets.SF_ORG_CLIENT_SECRET }}
                  SF_ORG_CLIENT_USERNAME: ${{ secrets.SF_ORG_CLIENT_USERNAME }}
                  SF_ORG_CLIENT_PASSWORD: ${{ secrets.SF_ORG_CLIENT_PASSWORD }}

            - name: Create Salesforce project
              run: |
                  echo "Creating Salesforce project..."
                  if sf project generate --name SalesforceTestProject --output-dir . &>/dev/null; then
                    echo "✅ Successfully created Salesforce project"
                  else
                    echo "❌ Failed to create Salesforce project"
                    exit 1
                  fi

                  echo "Setting up project structure..."
                  ls -la

                  # Move force-app directory to current location
                  mv SalesforceTestProject/force-app .

                  # Copy sfdx-project.json to current location
                  cp SalesforceTestProject/sfdx-project.json .

                  # Clean up the generated project directory
                  rm -rf SalesforceTestProject

                  echo "Project setup completed:"
                  ls -la
